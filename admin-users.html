<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù…Ø¯Ø§Ø±Ùƒ Ø§Ù„Ù†Ø®Ø¨Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        *{font-family:'Tajawal',sans-serif}
        @keyframes spin-r{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        @keyframes shimmer{0%{background-position:200% center}100%{background-position:-200% center}}
        @keyframes gp{0%,100%{box-shadow:0 4px 20px rgba(99,102,241,.35)}50%{box-shadow:0 8px 32px rgba(99,102,241,.6)}}
        .ml{display:inline-flex;align-items:center;gap:10px;direction:rtl;text-decoration:none;user-select:none}
        .ml .ic{width:36px;height:36px;border-radius:10px;flex-shrink:0;background:linear-gradient(135deg,#1e1b4b,#2d2564);border:1.5px solid rgba(99,102,241,.35);display:flex;align-items:center;justify-content:center;position:relative;animation:gp 3s ease-in-out infinite}
        .ml .ic .rg{position:absolute;inset:2px;border-radius:8px;border:1.5px solid transparent;border-top-color:rgba(99,102,241,.8);border-right-color:rgba(139,92,246,.4);animation:spin-r 3s linear infinite}
        .ml .nm{font-family:'Cairo',sans-serif;font-size:18px;font-weight:900;background:linear-gradient(110deg,#c7d2fe 0%,#e0e7ff 20%,#818cf8 45%,#c4b5fd 70%,#c7d2fe 100%);background-size:300% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 5s linear infinite;line-height:1.1}
        .ml .tg{font-size:8.5px;color:rgba(196,181,253,.5);margin-top:1px;display:block}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 28px;border-radius:12px;font-size:.9rem;font-weight:700;z-index:999}
        .tok{background:linear-gradient(135deg,#10b981,#14b8a6);color:#fff}
        .ter{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
        .fbtn{background:#f1f5f9;color:#64748b;padding:8px 16px;border-radius:10px;font-size:.85rem;font-weight:700;cursor:pointer;border:none;transition:all .2s}
        .fbtn:hover{background:#e2e8f0}
        .fbtn.on{background:#6366f1;color:#fff}
        .spin{display:inline-block;width:28px;height:28px;border:3px solid rgba(99,102,241,.2);border-top-color:#6366f1;border-radius:50%;animation:spin-r .7s linear infinite}
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<div id="toast" class="toast hidden"></div>

<!-- Header -->
<header class="bg-white shadow-sm border-b sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <a href="admin.html" class="text-gray-400 hover:text-gray-700 transition p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <a href="index.html" class="ml">
                <div class="ic"><div class="rg"></div>
                    <svg viewBox="0 0 36 36" width="19" height="19" fill="none">
                        <path d="M5 26 L5 14 L11.5 20 L18 7 L24.5 20 L31 14 L31 26 Z" stroke="rgba(165,180,252,.95)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="5" y1="28.5" x2="31" y2="28.5" stroke="rgba(165,180,252,.7)" stroke-width="2.5" stroke-linecap="round"/>
                        <circle cx="5" cy="14" r="2.5" fill="#a5b4fc"/><circle cx="18" cy="7" r="2.5" fill="#c4b5fd"/><circle cx="31" cy="14" r="2.5" fill="#a5b4fc"/>
                    </svg>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end">
                    <span class="nm">Ù…Ø¯Ø§Ø±Ùƒ Ø§Ù„Ù†Ø®Ø¨Ø©</span><span class="tg">Ø­ÙŠØ« ÙŠÙØµÙ†Ø¹ Ø§Ù„ØªÙ…ÙŠÙ‘Ø²</span>
                </div>
            </a>
            <h1 class="text-lg font-black text-gray-800">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-gray-400 text-sm" id="adminName">...</span>
            <button onclick="sb.auth.signOut().then(()=>location.href='admin-login.html')"
                class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 py-6">

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</p>
            <p class="text-3xl font-black text-gray-800" id="s-total">-</p>
        </div>
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs mb-1">Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙØ¹Ø§Ù„ÙŠÙ†</p>
            <p class="text-3xl font-black text-indigo-600" id="s-paid">-</p>
        </div>
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs mb-1">Ø´Ù‡Ø±ÙŠ</p>
            <p class="text-3xl font-black text-blue-600" id="s-monthly">-</p>
        </div>
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <p class="text-gray-400 text-xs mb-1">Ø³Ù†ÙˆÙŠ</p>
            <p class="text-3xl font-black text-purple-600" id="s-yearly">-</p>
        </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± + Ø¨Ø­Ø« -->
    <div class="bg-white rounded-2xl p-4 mb-5 shadow-sm flex flex-wrap gap-2 items-center justify-between">
        <div class="flex gap-2 flex-wrap" id="filters">
            <button class="fbtn on" onclick="setF('all',this)">Ø§Ù„ÙƒÙ„</button>
            <button class="fbtn" onclick="setF('monthly',this)">Ø´Ù‡Ø±ÙŠ ğŸ“…</button>
            <button class="fbtn" onclick="setF('yearly',this)">Ø³Ù†ÙˆÙŠ ğŸ’</button>
            <button class="fbtn" onclick="setF('free',this)">Ù…Ø¬Ø§Ù†ÙŠ</button>
            <button class="fbtn" onclick="setF('staff',this)">Ø£Ø¯Ù…Ù† / Ù…ÙˆØ¸Ù</button>
        </div>
        <input type="text" id="searchQ" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..."
            oninput="render(1)"
            class="border-2 border-gray-200 rounded-xl px-4 py-2 text-sm focus:border-indigo-400 focus:outline-none w-60">
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ -->
    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-500">Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-500">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500">Ø§Ù„Ø¯ÙˆØ±</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-500">Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="tbl">
                    <tr><td colspan="7" class="py-16 text-center text-gray-400">
                        <div class="spin mx-auto mb-2"></div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </td></tr>
                </tbody>
            </table>
        </div>
        <!-- pagination -->
        <div class="px-4 py-3 border-t flex items-center justify-between bg-gray-50">
            <span class="text-xs text-gray-400" id="pgInfo">-</span>
            <div class="flex gap-2">
                <button onclick="render(pg-1)" id="prevBtn" disabled
                    class="px-3 py-1.5 rounded-lg bg-white border text-xs font-bold text-gray-500 hover:bg-gray-100 disabled:opacity-30 transition">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button onclick="render(pg+1)" id="nextBtn" disabled
                    class="px-3 py-1.5 rounded-lg bg-white border text-xs font-bold text-gray-500 hover:bg-gray-100 disabled:opacity-30 transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            </div>
        </div>
    </div>
</main>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
<div id="editM" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-black text-gray-800">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ</h2>
            <button onclick="closeM()" class="text-gray-300 hover:text-gray-600 text-2xl leading-none">âœ•</button>
        </div>
        <input type="hidden" id="m-id">
        <div class="space-y-3">
            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">Ø§Ù„Ø§Ø³Ù…</label>
                <input id="m-name" type="text" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:border-indigo-400 focus:outline-none">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
                <input id="m-email" type="email" disabled class="w-full border-2 border-gray-100 bg-gray-50 rounded-xl px-4 py-2.5 text-sm text-gray-400">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                <select id="m-sub" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:border-indigo-400 focus:outline-none">
                    <option value="free">Ù…Ø¬Ø§Ù†ÙŠ</option>
                    <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
                    <option value="yearly">Ø³Ù†ÙˆÙŠ</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">Ø§Ù„Ø¯ÙˆØ±</label>
                <select id="m-role" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:border-indigo-400 focus:outline-none">
                    <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                    <option value="staff">Ù…ÙˆØ¸Ù</option>
                    <option value="admin">Ø£Ø¯Ù…Ù†</option>
                </select>
            </div>
            <div>
                <label class="text-xs font-bold text-gray-500 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label>
                <input id="m-exp" type="date" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2.5 text-sm focus:border-indigo-400 focus:outline-none">
            </div>
            <button onclick="saveM()" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-bold hover:bg-indigo-600 transition text-sm">
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
var sb=window.supabase.createClient(
    'https://czzcmbxejxbotjemyuqf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6emNtYnhlanhib3RqZW15dXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNzQ0ODEsImV4cCI6MjA4NTc1MDQ4MX0.xDfG1qsDZGyUrpL44JfqOtk57dVsLaMsvIzJz1KgiR0'
);

var users=[], attMap={}, activeFilter='all', pg=1, PS=25;

function toast(m,ok){var t=document.getElementById('toast');t.textContent=m;t.className='toast '+(ok?'tok':'ter');setTimeout(function(){t.classList.add('hidden')},3000)}

async function init(){
    var{data:{session}}=await sb.auth.getSession();
    if(!session){location.href='admin-login.html';return}
    var{data:p}=await sb.from('profiles').select('role,full_name').eq('id',session.user.id).single();
    if(!p||(p.role!=='admin'&&p.role!=='staff')){location.href='admin-login.html';return}
    document.getElementById('adminName').textContent=p.full_name||'Ø§Ù„Ù…Ø¯ÙŠØ±';
    await load();
}

async function load(){
    var{data:u}=await sb.from('profiles').select('*').order('created_at',{ascending:false});
    users=u||[];
    var{data:a}=await sb.from('attempts').select('user_id');
    attMap={};
    if(a)a.forEach(function(x){attMap[x.user_id]=(attMap[x.user_id]||0)+1});
    stats();render(1);
}

function stats(){
    document.getElementById('s-total').textContent=users.length;
    document.getElementById('s-paid').textContent=users.filter(function(u){return u.subscription_type==='monthly'||u.subscription_type==='yearly'}).length;
    document.getElementById('s-monthly').textContent=users.filter(function(u){return u.subscription_type==='monthly'}).length;
    document.getElementById('s-yearly').textContent=users.filter(function(u){return u.subscription_type==='yearly'}).length;
}

function setF(f,btn){
    activeFilter=f;pg=1;
    document.querySelectorAll('.fbtn').forEach(function(b){b.classList.remove('on')});
    btn.classList.add('on');
    render(1);
}

function filtered(){
    var q=(document.getElementById('searchQ').value||'').trim().toLowerCase();
    return users.filter(function(u){
        var m=true;
        if(activeFilter==='monthly')m=u.subscription_type==='monthly';
        else if(activeFilter==='yearly')m=u.subscription_type==='yearly';
        else if(activeFilter==='free')m=!u.subscription_type||u.subscription_type==='free';
        else if(activeFilter==='staff')m=u.role==='admin'||u.role==='staff';
        return m&&(!q||(u.full_name||'').toLowerCase().includes(q)||(u.email||'').toLowerCase().includes(q));
    });
}

function render(p){
    pg=p||1;
    var all=filtered(),tot=all.length,pages=Math.max(1,Math.ceil(tot/PS));
    if(pg>pages)pg=pages;
    var start=(pg-1)*PS,slice=all.slice(start,start+PS);
    document.getElementById('pgInfo').textContent='Ø¹Ø±Ø¶ '+(tot===0?0:start+1)+' â€“ '+Math.min(start+PS,tot)+' Ù…Ù† '+tot;
    document.getElementById('prevBtn').disabled=pg<=1;
    document.getElementById('nextBtn').disabled=pg>=pages;

    var sCls={free:'bg-gray-100 text-gray-600',monthly:'bg-indigo-100 text-indigo-700',yearly:'bg-purple-100 text-purple-700'};
    var sLbl={free:'Ù…Ø¬Ø§Ù†ÙŠ',monthly:'Ø´Ù‡Ø±ÙŠ',yearly:'Ø³Ù†ÙˆÙŠ'};
    var rCls={user:'bg-blue-50 text-blue-600',admin:'bg-red-100 text-red-600',staff:'bg-violet-100 text-violet-600'};
    var rLbl={user:'Ù…Ø³ØªØ®Ø¯Ù…',admin:'Ø£Ø¯Ù…Ù†',staff:'Ù…ÙˆØ¸Ù'};

    if(!slice.length){
        document.getElementById('tbl').innerHTML='<tr><td colspan="7" class="py-16 text-center text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
    }

    var h=slice.map(function(u){
        var sub=u.subscription_type||'free',role=u.role||'user';
        var att=attMap[u.id]||0;
        var dt=u.created_at?new Date(u.created_at).toLocaleDateString('ar-SA'):'-';
        // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        var exp='';
        if(u.subscription_expires_at&&sub!=='free'){
            var d=Math.ceil((new Date(u.subscription_expires_at)-new Date())/(86400000));
            if(d<0)exp='<div class="text-red-400 text-xs">Ù…Ù†ØªÙ‡ÙŠ</div>';
            else if(d<=7)exp='<div class="text-amber-500 text-xs">Ø¨Ø¹Ø¯ '+d+' ÙŠÙˆÙ…</div>';
        }
        return '<tr class="border-b hover:bg-blue-50/30 transition">'
            +'<td class="px-4 py-3"><div class="flex items-center gap-2"><span class="text-lg">'+(u.avatar_emoji||'ğŸ‘¤')+'</span><span class="font-bold text-gray-800 text-sm">'+(u.full_name||'â€”')+'</span></div></td>'
            +'<td class="px-4 py-3 text-gray-400 text-sm">'+(u.email||'â€”')+'</td>'
            +'<td class="px-4 py-3 text-center"><span class="px-2 py-0.5 rounded-lg text-xs font-bold '+(rCls[role]||'bg-gray-100 text-gray-500')+'">'+(rLbl[role]||role)+'</span></td>'
            +'<td class="px-4 py-3 text-center"><span class="px-2 py-0.5 rounded-lg text-xs font-bold '+sCls[sub]+'">'+sLbl[sub]+'</span>'+exp+'</td>'
            +'<td class="px-4 py-3 text-center text-sm font-bold text-gray-600">'+att+'</td>'
            +'<td class="px-4 py-3 text-center text-xs text-gray-400">'+dt+'</td>'
            +'<td class="px-4 py-3 text-center"><button onclick="openM(\''+u.id+'\')" class="px-3 py-1 rounded-lg bg-indigo-50 text-indigo-600 text-xs font-bold hover:bg-indigo-100 transition">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button></td>'
            +'</tr>';
    }).join('');
    document.getElementById('tbl').innerHTML=h;
}

function openM(id){
    var u=users.find(function(x){return x.id===id});
    if(!u)return;
    document.getElementById('m-id').value=u.id;
    document.getElementById('m-name').value=u.full_name||'';
    document.getElementById('m-email').value=u.email||'';
    document.getElementById('m-sub').value=u.subscription_type||'free';
    document.getElementById('m-role').value=u.role||'user';
    document.getElementById('m-exp').value=u.subscription_expires_at?(u.subscription_expires_at.substring(0,10)):'';
    document.getElementById('editM').classList.remove('hidden');
}
function closeM(){document.getElementById('editM').classList.add('hidden')}

async function saveM(){
    var id=document.getElementById('m-id').value;
    var upd={
        full_name:document.getElementById('m-name').value,
        subscription_type:document.getElementById('m-sub').value,
        role:document.getElementById('m-role').value,
        subscription_expires_at:document.getElementById('m-exp').value||null
    };
    var{error}=await sb.from('profiles').update(upd).eq('id',id);
    if(error){toast('Ø®Ø·Ø£: '+error.message,false);return}
    var i=users.findIndex(function(x){return x.id===id});
    if(i!==-1)users[i]=Object.assign(users[i],upd);
    toast('ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ“',true);
    closeM();stats();render(pg);
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
