<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>التدريب - مساري</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    * { font-family: 'Tajawal', sans-serif; }

    .equation-display {
      font-size: 1.4rem;
      font-weight: 600;
      direction: ltr;
      text-align: center;
      padding: 1rem;
      background: #f8f9ff;
      border-radius: 0.75rem;
      margin: 1rem 0;
      border: 2px solid #e0e7ff;
    }

    .option-btn {
      transition: all 0.25s ease;
    }

    .option-btn:hover:not(:disabled) {
      transform: translateX(-4px);
    }

    .correct-answer {
      background: #10b981 !important;
      color: white !important;
      border-color: #059669 !important;
    }

    .wrong-answer {
      background: #ef4444 !important;
      color: white !important;
      border-color: #dc2626 !important;
    }

    .show-correct {
      border: 3px solid #10b981 !important;
      background: #d1fae5 !important;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-indigo-50 via-white to-blue-50 min-h-screen">

<header class="bg-white shadow-sm border-b border-indigo-100 sticky top-0 z-10">
  <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">

    <div class="flex items-center gap-3">
      <button onclick="confirmExit()" class="text-gray-600 hover:text-gray-800">
        ←
      </button>
      <h1 class="text-xl font-bold">التدريب</h1>
    </div>

    <div>
      السؤال <span id="currentQuestion">1</span> من
      <span id="totalQuestions">10</span>
    </div>

  </div>

  <div class="w-full bg-gray-200 h-1">
    <div id="progressBar"
      class="bg-gradient-to-r from-indigo-500 to-blue-500 h-1"
      style="width:0%"></div>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 py-8">

  <div id="questionCard"
       class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8">

    <div class="flex gap-2 mb-4">
      <span id="subjectBadge"
            class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">القسم</span>
      <span id="difficultyBadge"
            class="px-3 py-1 bg-gray-100 rounded-full text-sm">متوسط</span>
    </div>

    <h2 id="questionText" class="text-2xl font-bold mb-4"></h2>

    <div id="equationDisplay" class="equation-display hidden"></div>

    <div id="optionsContainer" class="space-y-3 mb-6"></div>

    <div id="feedbackMessage" class="hidden p-4 rounded-lg mb-4">
      <p id="feedbackText" class="font-bold"></p>
      <p id="explanationText" class="text-sm mt-2"></p>
    </div>

    <button id="nextBtn"
            onclick="nextQuestion()"
            class="hidden w-full bg-indigo-600 text-white py-3 rounded-xl">
      السؤال التالي
    </button>

  </div>

</main>

<script src="questions_bank.js"></script>
<script src="motivations.js"></script>

<script>
let questions = [];
let currentQuestionIndex = 0;
let sessionAttempts = [];
let user = JSON.parse(localStorage.getItem("masari_user") || "null");


// ======================
// تحويل صيغة السؤال (Mapping)
// ======================
function normalizeQuestion(q){
  return {
    id: q.id,
    subject: q.subject || q.section || "—",
    section: q.section || "",
    difficulty: q.difficulty || "medium",
    questionText: q.question_text || q.question || "",
    equation: q.equation || "",
    options: q.options || q.choices || [],
    correctIndex: q.correctAnswer ?? q.correct_index,
    explanation: q.explanation || ""
  };
}


// ======================
// تحميل جميع الأسئلة
// ======================
function loadAllQuestions(){
  const saved = localStorage.getItem("masari_custom_questions");

  if(saved){
    try{
      const arr = JSON.parse(saved);
      if(Array.isArray(arr) && arr.length){
        return arr.map(normalizeQuestion);
      }
    }catch(e){}
  }

  if(typeof questionsBank !== "undefined"){
    return questionsBank.map(normalizeQuestion);
  }

  return [];
}


// ======================
// اختيار عشوائي حسب القسم
// ======================
function getRandomQuestions(count){
  const selectedSection = localStorage.getItem("masari_selected_section");
  let allQ = loadAllQuestions();

  if(selectedSection){
    allQ = allQ.filter(q =>
      (q.section || "").toLowerCase() === selectedSection.toLowerCase()
    );
  }

  if(allQ.length === 0){
    alert("ما فيه أسئلة في هذا القسم حالياً");
    window.location.href = "select-section.html";
    return [];
  }

  allQ.sort(()=>Math.random()-0.5);
  return allQ.slice(0, Math.min(count, allQ.length));
}


// ======================
// عرض السؤال
// ======================
function displayQuestion(){
  const q = questions[currentQuestionIndex];

  document.getElementById("currentQuestion").textContent = currentQuestionIndex+1;
  document.getElementById("totalQuestions").textContent = questions.length;

  document.getElementById("questionText").textContent = q.questionText;
  document.getElementById("subjectBadge").textContent = q.subject;

  document.getElementById("difficultyBadge").textContent =
    ({easy:"سهل",medium:"متوسط",hard:"صعب"})[q.difficulty] || "متوسط";

  const eq = document.getElementById("equationDisplay");
  if(q.equation){
    eq.classList.remove("hidden");
    eq.textContent = q.equation;
  }else{
    eq.classList.add("hidden");
  }

  const optionsContainer = document.getElementById("optionsContainer");

  optionsContainer.innerHTML = q.options.map((o,i)=>`
    <button id="option-${i}"
      onclick="selectAnswer(${i})"
      class="option-btn w-full text-right p-4 rounded-xl border-2 border-gray-200 hover:border-indigo-400">
      ${o}
    </button>
  `).join("");

  document.getElementById("nextBtn").classList.add("hidden");
  document.getElementById("feedbackMessage").classList.add("hidden");

  const progress=((currentQuestionIndex+1)/questions.length)*100;
  document.getElementById("progressBar").style.width=progress+"%";
}


// ======================
function selectAnswer(index){
  const q = questions[currentQuestionIndex];
  const isCorrect = index === q.correctIndex;

  for(let i=0;i<q.options.length;i++){
    document.getElementById("option-"+i).disabled=true;
  }

  const selectedBtn=document.getElementById("option-"+index);
  const correctBtn=document.getElementById("option-"+q.correctIndex);

  if(isCorrect){
    selectedBtn.classList.add("correct-answer");
  }else{
    selectedBtn.classList.add("wrong-answer");
    correctBtn.classList.add("show-correct");
  }

  const msg=document.getElementById("feedbackMessage");
  msg.classList.remove("hidden");

  document.getElementById("feedbackText").textContent =
    isCorrect ? "إجابة صحيحة" : "إجابة خاطئة";

  document.getElementById("explanationText").textContent =
    q.explanation ? "التوضيح: "+q.explanation : "";

  sessionAttempts.push({isCorrect});

  document.getElementById("nextBtn").classList.remove("hidden");
}


// ======================
function nextQuestion(){
  currentQuestionIndex++;
  if(currentQuestionIndex>=questions.length){
    window.location.href="dashboard.html";
    return;
  }
  displayQuestion();
}


// ======================
function confirmExit(){
  window.location.href="select-section.html";
}


// ======================
function init(){
  questions = getRandomQuestions(10);
  if(!questions.length) return;
  displayQuestion();
}

init();
</script>

</body>
</html>
